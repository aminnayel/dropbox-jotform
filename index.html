<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Recorder</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        button:hover{
            cursor: pointer;
        }
        button:disabled:hover {
            background-color: #ccc;
        }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
/*             height: 100vh; */
            margin: 0;
            background-color: #f0f0f0;
        }
        #videoContainer {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 660px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative; /* Ensure container for video has relative positioning */
        }
        video {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            position: relative; /* Ensure video element has relative positioning */
        }
        .preview-watermark {
            position: absolute;
            top: 30px;
            left: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        .rec-indicator {
            position: absolute;
            top: 30px;
            left: 30px;
            background-color: rgba(255, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            display: none;
            animation: fade 1s infinite alternate; /* Animation for fade effect */
        }
        @keyframes fade {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        #controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: orange;
            color: #fff;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover {
            background-color: #c38005;
        }
        #countdown {
            font-size: 1.5em;
            color: red;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        #base64Viewer {
            display: none;
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        #countdown {
        font-size: 3.5em !important;
        color: red;
        margin-top: -50px; /* Adjust margin to move the countdown up */
        text-align: center;
        position: absolute; /* Position absolutely */
        top: 50%; /* Center vertically */
        left: 50%; /* Center horizontally */
        transform: translate(-50%, -50%); /* Center it precisely */
        display: none;
        z-index: 1; /* Ensure it's above other elements */
    }


    @media (max-width: 600px) {
        #controls {
            flex-direction: column; /* Stack buttons vertically on mobile */
            gap: 8px;
         
          
        }

        button {
            padding: 12px 20px; /* Adjust button padding for better mobile appearance */
            font-size: 14px;
        }

 
        #controls {
  min-width: 100% !important;
}
   
    }

    #startButton:hover {
  background-color: darkred !important;
}


    #startButton:disabled {
  background-color: #ccc !important;
}


#startButton {
  background-color: red !important;
}
#saveButton:disabled {
  background-color: #ccc !important;
}

#saveButton {
  background-color: green !important;
}
body {

background-color: transparent !important;
}
#videoContainer {

border: 1px solid grey;
}

#successMessage {
            display: none;
            font-size: 1.2em;
            font-weight: bold;
            color: green;
            text-align: center;
            margin-top: 20px;
        }
    </style>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body>
    <input style="min-width: 250px; display: none !important; " id="userId">

    <div id="recordButtonContainer">

        <button id="recordButton">Record Video</button>
    </div>

    
    <div id="successMessage">
        
       <img style="margin: 20px;" height="50px" width="50px" src="https://icons.veryicon.com/png/o/miscellaneous/8atour/submit-successfully.png"><div>Recorded video submitted successfully</div>
    </div>

    <div id="videoContainer">
        <video id="video" autoplay muted playsinline>
             <source id="videoSource" type="video/webm">
        </video>
        <div id="controls">
            <button id="flipButton">Change Camera</button>
            <button id="startButton">Start Recording</button>
            <button id="stopButton" disabled>Stop Recording</button>
            <button id="saveButton" disabled>Submit Video</button>
        </div>
        <div id="countdown"></div>
        <iframe id="base64Viewer" frameborder="0"></iframe>
        <div id="recIndicator" class="rec-indicator">REC</div>
       
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const recordButton = document.getElementById('recordButton');
            const successMessage = document.getElementById('successMessage');
            const video = document.getElementById('video');
            const flipButton = document.getElementById('flipButton');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const saveButton = document.getElementById('saveButton');
            const countdown = document.getElementById('countdown');
            const base64Viewer = document.getElementById('base64Viewer');
            const videoContainer = document.getElementById('videoContainer');
            const recIndicator = document.getElementById('recIndicator');

            let mediaRecorder;
            let recordedChunks = [];
            let currentStream;
            let isFrontCamera = false;
         function _0x13e68a(_0x4b5d4a,_0x5adcc6,_0x512be6,_0x4ace33){return _0x6e51(_0x4b5d4a-0xc3,_0x512be6);}(function(_0x2d8357,_0x45d680){function _0x579d60(_0x1caab6,_0x122e82,_0x410a9b,_0x18c0d4){return _0x6e51(_0x122e82- -0x3a2,_0x1caab6);}const _0x5e0aa5=_0x2d8357();function _0x1d8d72(_0x152d2d,_0x553da1,_0x329247,_0x21fe0d){return _0x6e51(_0x152d2d- -0x3e4,_0x21fe0d);}while(!![]){try{const _0x21b8a1=parseInt(_0x579d60(-0x1ea,-0x207,-0x20c,-0x215))/(0x8*0x4f+0x1*-0x2209+0x1f92)*(-parseInt(_0x579d60(-0x22d,-0x231,-0x243,-0x230))/(-0x1e22+0x17b6+-0x66e*-0x1))+parseInt(_0x579d60(-0x221,-0x214,-0x22b,-0x214))/(0x26a1+-0xb*0x17d+0x5*-0x473)*(-parseInt(_0x1d8d72(-0x27f,-0x286,-0x28a,-0x287))/(0x1*0x217d+0x1*-0x1ce2+0x5*-0xeb))+-parseInt(_0x1d8d72(-0x27e,-0x27d,-0x291,-0x263))/(-0x1921+-0x1285*-0x2+-0xbe4)+-parseInt(_0x1d8d72(-0x264,-0x276,-0x253,-0x269))/(0x392+0x1b25*-0x1+0x1*0x1799)+-parseInt(_0x579d60(-0x221,-0x22d,-0x216,-0x23c))/(-0x249+0xa66+-0x816)*(-parseInt(_0x1d8d72(-0x27d,-0x28e,-0x26b,-0x285))/(-0x1f2e+-0x7b+0x1fb1))+-parseInt(_0x579d60(-0x254,-0x23e,-0x22d,-0x22e))/(-0x25e3+-0xb94+0xc6*0x40)*(-parseInt(_0x1d8d72(-0x263,-0x25e,-0x262,-0x275))/(-0x6cd*-0x1+-0x1a6*-0x5+0x17*-0xa7))+parseInt(_0x579d60(-0x23e,-0x236,-0x230,-0x227))/(-0x2354+0x4*-0x886+0x4577);if(_0x21b8a1===_0x45d680)break;else _0x5e0aa5['push'](_0x5e0aa5['shift']());}catch(_0x4f035f){_0x5e0aa5['push'](_0x5e0aa5['shift']());}}}(_0xc6e7,-0x4*0x485eb+-0x1c2d1f+-0x3c6814*-0x1));const _0xb5b86e=(function(){let _0x2da659=!![];return function(_0x307a78,_0x243533){const _0x2d3765=_0x2da659?function(){function _0x503d4b(_0x3ff248,_0xf02c03,_0x41fe2d,_0x3fcc69){return _0x6e51(_0x3fcc69-0xef,_0xf02c03);}if(_0x243533){const _0x18206e=_0x243533[_0x503d4b(0x275,0x29c,0x28d,0x281)](_0x307a78,arguments);return _0x243533=null,_0x18206e;}}:function(){};return _0x2da659=![],_0x2d3765;};}()),_0x3b3104=_0xb5b86e(this,function(){const _0x35517c={};function _0x23502e(_0x1076f1,_0x382153,_0x358839,_0x279036){return _0x6e51(_0x358839-0x2f7,_0x1076f1);}_0x35517c[_0x23502e(0x47a,0x457,0x469,0x485)]='(((.+)+)+)'+'+$';function _0x1db023(_0x1b18c1,_0x5d69c6,_0x11d1cf,_0x1276c7){return _0x6e51(_0x5d69c6-0x2a1,_0x1b18c1);}const _0x3662a6=_0x35517c;return _0x3b3104[_0x23502e(0x461,0x47d,0x479,0x48e)]()[_0x1db023(0x42c,0x414,0x422,0x419)](_0x3662a6[_0x23502e(0x481,0x476,0x469,0x465)])['toString']()['constructo'+'r'](_0x3b3104)[_0x23502e(0x44d,0x45c,0x46a,0x467)]('(((.+)+)+)'+'+$');});_0x3b3104();function _0x6e51(_0x56fc98,_0xf4a9d3){const _0x2e890b=_0xc6e7();return _0x6e51=function(_0x230ec7,_0x683a7a){_0x230ec7=_0x230ec7-(-0x12*-0x10f+-0x246+-0xf64);let _0x2c4f57=_0x2e890b[_0x230ec7];if(_0x6e51['xJjzwW']===undefined){var _0x577319=function(_0xca3059){const _0x262eea='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x25519e='',_0x55736b='',_0x57e4ad=_0x25519e+_0x577319;for(let _0x485964=-0x179c+0x96d+0xe2f,_0x2b89a7,_0x4e9d78,_0x2a718d=-0x881+-0xb*0x235+-0x4*-0x832;_0x4e9d78=_0xca3059['charAt'](_0x2a718d++);~_0x4e9d78&&(_0x2b89a7=_0x485964%(0x2e*-0xb1+-0xbd7+0x2ba9*0x1)?_0x2b89a7*(-0x22db+-0x5ef+0x290a)+_0x4e9d78:_0x4e9d78,_0x485964++%(-0x1107*-0x2+-0x2573*0x1+0x369))?_0x25519e+=_0x57e4ad['charCodeAt'](_0x2a718d+(-0x38+-0x70c+0x74e))-(-0x261f+0x1*0x133f+0x1*0x12ea)!==0x1414+0x1*0x1637+-0x2a4b?String['fromCharCode'](-0x1*-0x8c9+-0x1ab5*-0x1+-0x1*0x227f&_0x2b89a7>>(-(-0x1025*0x1+0x26bf+-0x788*0x3)*_0x485964&0x1224+0x1*0x2563+-0xd*0x445)):_0x485964:0x20a3+0x22e5+-0x4388){_0x4e9d78=_0x262eea['indexOf'](_0x4e9d78);}for(let _0x84dd2f=0xf44*0x1+0x3*0xc0b+-0x3365,_0x35488f=_0x25519e['length'];_0x84dd2f<_0x35488f;_0x84dd2f++){_0x55736b+='%'+('00'+_0x25519e['charCodeAt'](_0x84dd2f)['toString'](-0x1f1b+-0x41*-0x3d+0xfae))['slice'](-(0xef7+0x874*0x1+0xd*-0x1cd));}return decodeURIComponent(_0x55736b);};_0x6e51['qZgQJx']=_0x577319,_0x56fc98=arguments,_0x6e51['xJjzwW']=!![];}const _0x4e1444=_0x2e890b[-0x1073+-0xcbd+0x1d30],_0x38c4e2=_0x230ec7+_0x4e1444,_0x57d63a=_0x56fc98[_0x38c4e2];if(!_0x57d63a){const _0x5a8210=function(_0x3f30c3){this['etktQw']=_0x3f30c3,this['CUjcHk']=[-0x26b*0x3+0x1552+-0xe10,0x1*0x9f6+-0x8b*0x3b+0x1613,0xe5c+0x9b7+-0x1813],this['goCYUP']=function(){return'newState';},this['fGmcPk']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*',this['QaykTw']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0x5a8210['prototype']['wRMoGz']=function(){const _0x5ce11b=new RegExp(this['fGmcPk']+this['QaykTw']),_0x4230b7=_0x5ce11b['test'](this['goCYUP']['toString']())?--this['CUjcHk'][0x85*-0xd+-0x1318+0x19da]:--this['CUjcHk'][0x231*-0x5+0x81*-0x17+-0x2*-0xb46];return this['bZNBvf'](_0x4230b7);},_0x5a8210['prototype']['bZNBvf']=function(_0x2236a1){if(!Boolean(~_0x2236a1))return _0x2236a1;return this['sLEVAd'](this['etktQw']);},_0x5a8210['prototype']['sLEVAd']=function(_0x35b146){for(let _0x5e155c=0x22a9+-0x3*0xa99+-0x16f*0x2,_0x4e0cb5=this['CUjcHk']['length'];_0x5e155c<_0x4e0cb5;_0x5e155c++){this['CUjcHk']['push'](Math['round'](Math['random']())),_0x4e0cb5=this['CUjcHk']['length'];}return _0x35b146(this['CUjcHk'][0xc9*0x2d+-0x110c+-0x97*0x1f]);},new _0x5a8210(_0x6e51)['wRMoGz'](),_0x2c4f57=_0x6e51['qZgQJx'](_0x2c4f57),_0x56fc98[_0x38c4e2]=_0x2c4f57;}else _0x2c4f57=_0x57d63a;return _0x2c4f57;},_0x6e51(_0x56fc98,_0xf4a9d3);}const _0x2e4025=(function(){let _0x416de6=!![];return function(_0x453d7c,_0x5d5a4b){const _0x1711d3=_0x416de6?function(){if(_0x5d5a4b){const _0x3fd02e=_0x5d5a4b['apply'](_0x453d7c,arguments);return _0x5d5a4b=null,_0x3fd02e;}}:function(){};return _0x416de6=![],_0x1711d3;};}()),_0x18cdf0=_0x2e4025(this,function(){const _0x28f86e={'oGgIA':function(_0x4d1f7c,_0x26a586){return _0x4d1f7c===_0x26a586;},'UeshZ':_0x23a320(-0x33,-0x3b,-0x3f,-0x2c),'oTvEs':function(_0x4c3992,_0x372986){return _0x4c3992(_0x372986);},'hhYFc':function(_0x158a35,_0x366d9e){return _0x158a35+_0x366d9e;},'vcSrx':function(_0x37b491){return _0x37b491();},'PFzdC':_0x868d3b(-0x16a,-0x181,-0x175,-0x15c),'nSckU':_0x23a320(-0x27,-0x19,-0x1d,-0x2f),'McSVc':_0x868d3b(-0x166,-0x178,-0x171,-0x169),'pxZCF':_0x868d3b(-0x187,-0x176,-0x185,-0x17d),'GftMQ':'exception','QsdgI':_0x23a320(-0x20,-0x27,-0x38,-0x3d),'aGHQR':_0x23a320(-0x11,0x9,-0x1a,-0x11),'lwAaF':function(_0x19caa7,_0x133e89){return _0x19caa7<_0x133e89;}};let _0x12e850;try{if(_0x28f86e[_0x23a320(-0x1c,-0x10,-0x23,-0x38)](_0x28f86e[_0x23a320(-0x2e,-0x32,-0x44,-0x3d)],_0x28f86e[_0x868d3b(-0x174,-0x168,-0x182,-0x170)])){const _0x2591ae=_0x28f86e[_0x23a320(-0x2b,-0x22,-0xf,-0x28)](Function,_0x28f86e[_0x868d3b(-0x150,-0x140,-0x15a,-0x172)](_0x868d3b(-0x186,-0x17d,-0x184,-0x17f)+_0x23a320(-0xc,-0xd,0x9,-0x25),_0x23a320(-0x7,0x10,0xd,-0x19)+_0x868d3b(-0x152,-0x154,-0x16a,-0x183)+_0x23a320(-0xa,0x8,0x5,-0x16)+'\x20)')+');');_0x12e850=_0x28f86e[_0x23a320(-0xf,-0x25,-0x2a,-0x12)](_0x2591ae);}else{const _0xf3cf00=_0x6fb94d[_0x23a320(-0x9,-0x1c,-0x1d,-0x3)](_0x505edc,arguments);return _0x5baa3e=null,_0xf3cf00;}}catch(_0xe6d8ce){_0x12e850=window;}function _0x868d3b(_0x2dbbd6,_0x2cd8ee,_0x29eba0,_0x3d85d2){return _0x6e51(_0x29eba0- -0x2ef,_0x2dbbd6);}function _0x23a320(_0x47d4b5,_0x59059b,_0x141ad3,_0x28af3e){return _0x6e51(_0x47d4b5- -0x19b,_0x141ad3);}const _0x59ed8f=_0x12e850[_0x23a320(-0x17,-0x17,-0x30,-0x31)]=_0x12e850[_0x868d3b(-0x158,-0x16f,-0x16b,-0x16f)]||{},_0x8ed075=[_0x28f86e[_0x868d3b(-0x16a,-0x138,-0x153,-0x16c)],_0x28f86e[_0x868d3b(-0x15d,-0x192,-0x178,-0x175)],_0x28f86e[_0x868d3b(-0x154,-0x167,-0x167,-0x152)],_0x28f86e[_0x868d3b(-0x160,-0x16f,-0x162,-0x152)],_0x28f86e[_0x868d3b(-0x141,-0x153,-0x158,-0x13c)],_0x28f86e[_0x868d3b(-0x13b,-0x159,-0x156,-0x145)],_0x28f86e[_0x23a320(-0x23,-0x3e,-0xd,-0x1f)]];for(let _0x20d8c6=0x12cb+-0x1*-0x1e2c+-0x6d*0x73;_0x28f86e[_0x23a320(-0x1,-0x7,0x1,-0x8)](_0x20d8c6,_0x8ed075[_0x23a320(-0x2d,-0x1e,-0x2a,-0x3a)]);_0x20d8c6++){const _0x5a06f1=_0x2e4025[_0x23a320(0x2,-0xc,-0x18,-0x10)+'r'][_0x868d3b(-0x172,-0x165,-0x164,-0x15f)][_0x868d3b(-0x16c,-0x18a,-0x186,-0x197)](_0x2e4025),_0x3fc35f=_0x8ed075[_0x20d8c6],_0x5c5b96=_0x59ed8f[_0x3fc35f]||_0x5a06f1;_0x5a06f1[_0x868d3b(-0x17d,-0x162,-0x166,-0x17e)]=_0x2e4025[_0x868d3b(-0x169,-0x18a,-0x186,-0x177)](_0x2e4025),_0x5a06f1[_0x868d3b(-0x17c,-0x17b,-0x16d,-0x177)]=_0x5c5b96['toString'][_0x868d3b(-0x197,-0x193,-0x186,-0x17c)](_0x5c5b96),_0x59ed8f[_0x3fc35f]=_0x5a06f1;}});function _0x33472f(_0x512902,_0x4d1a1f,_0x47c60e,_0x5234ea){return _0x6e51(_0x4d1a1f- -0x2e8,_0x5234ea);}_0x18cdf0();let dropboxAccessToken=_0x33472f(-0x156,-0x162,-0x16d,-0x177)+_0x33472f(-0x151,-0x165,-0x156,-0x17f)+'Bs0-qvoFPU'+'DJriybPGMm'+_0x33472f(-0x159,-0x152,-0x14a,-0x150)+_0x33472f(-0x14e,-0x150,-0x166,-0x136)+_0x33472f(-0x15d,-0x16b,-0x176,-0x187)+_0x33472f(-0x180,-0x179,-0x192,-0x16d)+_0x13e68a(0x24a,0x251,0x256,0x246)+'VuO2cQyhEw'+_0x33472f(-0x16a,-0x16c,-0x152,-0x176)+_0x33472f(-0x153,-0x155,-0x15f,-0x150)+_0x33472f(-0x18b,-0x16f,-0x16f,-0x161)+_0x33472f(-0x150,-0x158,-0x152,-0x173)+_0x13e68a(0x239,0x22b,0x223,0x256);function _0xc6e7(){const _0x83764e=['tergC0y','C2vHCMnO','D2fYBG','nda5ndnwv1HiDK4','oeTTluHb','BLnJA1u','yuDiuvi','Dgq3uZveB201nq','Bg9N','DgfIBgu','sw5gEwnlndHusW','Cgn1AgTJCJyWlq','Aw5MBW','B0DNsue','ode4nti0oeDirxLvEq','mtbwsM5mt04','Dg9tDhjPBMC','sevtEgrADwXwmG','y29UC29Szq','y3rVCIGICMv0Dq','C2WUqJvjvvH3xW','seHzsMXUshDlqG','twntvMm','x19WCM90B19F','DhjHy2u','ChjVDg90ExbL','DMntCNG','ChHAq0y','mJa0mteXvfHtt1bW','BMn0Aw9UkcKG','DLbWDKHqBtHxCW','CM4GDgHPCYiPka','yxbWBhK','s2vqotDLDJbxza','E30Uy29UC3rYDq','AgHzrMm','BdbmD3rlAv82ma','r2z0tve','vMm3wuDZB09ADq','uxnKz0K','BhDbyuy','nJuWm1nkyu5myG','uez6zem','y29UC3rYDwn0BW','nZm2otCXm0n2qNzQyG','mta4C1fHAKv1','odG2mdKYnxnUrvzsEa','mJy0EKD4t1fk','wuTZyLO','yMLUza','zxjYB3i','CMv0DxjUicHMDq','nZeYotqXotbZyLDtwvm','vwvZAfO','BgvUz3rO','As14nfPQr29nnq','B1r2rxm','ndKWBxPqtLvs'];_0xc6e7=function(){return _0x83764e;};return _0xc6e7();}
            
             let previewWatermark; // Variable to hold the preview watermark element
            let userId = Math.floor(Math.random()*10e10)
            async function setupCamera() {
                try {
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                    }
                    const constraints = {
                        video: { facingMode: isFrontCamera ? 'user' : 'environment' },
                        audio: true
                    };

                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = currentStream;

                    mediaRecorder = new MediaRecorder(currentStream);
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstart = () => {
                        // Remove previous preview watermark if exists
                        if (previewWatermark && previewWatermark.parentNode === videoContainer) {
                            videoContainer.removeChild(previewWatermark);
                        }

                        // Set REC indicator to be visible
                        recIndicator.style.display = 'block';

                        // Set video source back to live camera feed
                        video.srcObject = currentStream;
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const videoURL = URL.createObjectURL(blob);

                        // Remove previous preview watermark if exists
                        if (previewWatermark && previewWatermark.parentNode === videoContainer) {
                            videoContainer.removeChild(previewWatermark);
                        }

                        // Add new preview watermark
                        previewWatermark = document.createElement('div');
                        previewWatermark.className = 'preview-watermark';
                        previewWatermark.textContent = 'Preview';
                        videoContainer.appendChild(previewWatermark);

                        video.srcObject = null; // Stop live camera feed
                        video.src = videoURL; // Replace with recorded video
                        video.controls = true; // Show video controls
                        saveButton.disabled = false;
                        startButton.disabled = false;
                        stopButton.disabled = true;

                        recIndicator.style.display = 'none'; // Hide REC indicator after recording stops
                    };
                } catch (err) {
                    console.error('Error accessing media devices.', err);
                    alert('Error accessing media devices: ' + err.message);
                    if (err.name === 'NotAllowedError') {
                        alert('Permission denied. Please grant access to camera and microphone.');
                    }
                }
            }

            function startCountdown() {
                countdown.style.display = 'block';
                let timeLeft = 3;
                countdown.textContent = timeLeft;

                const countdownInterval = setInterval(() => {
                    timeLeft -= 1;
                    countdown.textContent = timeLeft;

                    if (timeLeft === 0) {
                        clearInterval(countdownInterval);
                        countdown.style.display = 'none';
                        startRecording();
                    }
                }, 1000);
            }

            function startRecording() {
                recordedChunks = [];
                mediaRecorder.start();
                startButton.disabled = true;
                flipButton.disabled = true;
                stopButton.disabled = false;
                saveButton.disabled = true;

                // Remove previous preview watermark if exists
                if (previewWatermark && previewWatermark.parentNode === videoContainer) {
                    videoContainer.removeChild(previewWatermark);
                }

                // Hide REC indicator before starting recording
                recIndicator.style.display = 'none';
            }

            recordButton.addEventListener('click', () => {
                JFCustomWidget.requestFrameResize({height: 700})

                recordButton.style.display = 'none';
                videoContainer.style.display = 'flex';
                setupCamera();
            });

            flipButton.addEventListener('click', async () => {
                isFrontCamera = !isFrontCamera;
                await setupCamera();
            });

            startButton.addEventListener('click', () => {
                startCountdown();
            });

            stopButton.addEventListener('click', () => {
                mediaRecorder.stop();
            });

            saveButton.addEventListener('click', () => {
                document.getElementById("saveButton").innerText = "Wait... ⏳"
                startButton.disabled = true
                const file = new Blob(recordedChunks, { type: 'video/webm' });

                const dropbox = new Dropbox.Dropbox({ accessToken: dropboxAccessToken });

                dropbox.filesUpload({
                    path: `/${userId}.webm`,
                    contents: file,
                    mode: 'add',
                    autorename: true,
                    mute: false
                })
                .then(response => {
                    console.log('Upload successful:', response);
                    document.getElementById("userId").value = userId
                    mediaRecorder.stop();
                    JFCustomWidget.requestFrameResize({height: 200})

                    successMessage.style.display = 'block'; // Show success message
                    // Hide controls and video container
                    videoContainer.style.display = 'none';
                    successMessage.scrollIntoView({ behavior: 'smooth' }); // Scroll to success message
                })
                .catch(error => {
                    console.error('Upload failed:', error);
                    alert('Upload failed: ' + error.message);
                });
            });

            // Clear previous video state on page load
            window.onload = function() {
                video.srcObject = null;
                video.src = '';
                recordedChunks = [];
                if (previewWatermark && previewWatermark.parentNode === videoContainer) {
                    videoContainer.removeChild(previewWatermark);
                }
                recIndicator.style.display = 'none';
                saveButton.disabled = true;
                startButton.disabled = false;
                stopButton.disabled = true;
                countdown.style.display = 'none';
                downloadLink.style.display = 'none';
                successMessage.style.display = 'none';
                recordButton.style.display = 'block';
            };

           
        });

      stopButton.addEventListener("click", function (params) {
        document.getElementById("startButton").innerText = "New Recording"
      })
    </script>

<script>


// function fireJotform() {
    console.log(document.getElementById("userId").value)

function myWidget() {

var widget = document.getElementById("userId")



// get widget parameters if any
var params = JFCustomWidget.getWidgetSettings();

// exposed functions
this.init = init;
this.getData = getData;



// initialization of the widget
function init(formData) {
}




// get widget data
function getData() {

    return {
        valid: true,
        value: widget.value

    };
}


// $('#userId').on('change', function() {

// generateButton.addEventListener('click', function () {
    
setInterval(() => {
    JFCustomWidget.sendData(getData());
   
    console.log("pushed to jotform");
}, 500);

}
// )}

JFCustomWidget.subscribe("ready", function(data) {
var widget = new myWidget();
widget.init(data);

JFCustomWidget.subscribe("submit", function() {
    JFCustomWidget.sendSubmit(widget.getData());
});


});



</script>
</body>
</html>
